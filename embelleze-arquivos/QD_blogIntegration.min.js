(function ($, qdWindow){
	$.QD_blogIntegration = function(opts) {
		"use strict";

		// Configurações
		var defaults = {
			header: {
				iframe: "#qdBlogIntegration",
				width: "100%", // Largura do iframe
				height: 0, // Altura padrão do iframe
				zindex: 10
			},
			footer: {
				iframe: "#qdBlogIntegrationFooter",
				width: "100%", // Largura do iframe
				height: 0, // Altura padrão do iframe
				zindex: 9
			}
		};
		var options = $.extend(true, {}, defaults, opts);

		// HEADER
		var frameHeader = $(options.header.iframe);
		// Estilos
		frameHeader.css({
			width: options.header.width,
			height: options.header.height,
			overflow: "hidden",
			position: "absolute",
			top: 0,
			left: 0,
			"z-index": options.header.zindex
		});
		frameHeader.attr({
			allowtransparency: "true",
			scrolling: "no"
		});
		// Estilos do wrapper do iframe
		frameHeader.parent().css({
			width: options.header.width,
			height: options.header.height,
			position: "relative"
		});
		// Ações
		frameHeader.mouseleave(function() {
			frameHeader.height(options.header.height);
		});

		// FOOTER
		var frameFooter = $(options.footer.iframe);
		// Estilos
		frameFooter.css({
			width: options.footer.width,
			height: options.footer.height,
			overflow: "hidden",
			position: "absolute",
			top: 0,
			left: 0,
			"z-index": options.footer.zindex
		});
		frameFooter.attr({
			allowtransparency: "true",
			scrolling: "no"
		});
		// Estilos do wrapper do iframe
		frameFooter.parent().css({
			width: options.footer.width,
			height: options.footer.height,
			position: "relative"
		});
		// Ações
		frameFooter.mouseleave(function() {
			frameHeader.height(options.footer.height);
		});

		// Obervo se a janela foi redimensionada e então informo ao iframe
		$(window).resize(function() {
			try {
				frameHeader[0].contentWindow.postMessage("qdWindowResize", "*");
				frameFooter[0].contentWindow.postMessage("qdWindowResize", "*");
			}
			catch (e) {(typeof console !== "undefined" && typeof console.error === "function" && console.error("Não deu para mandar msg ao iframe . Detalhes: ", e)); }
		});

		// Funções com os eventos do postMessage
		try{
			var eventMethod = window.addEventListener? "addEventListener": "attachEvent";
			var messageEvent = (eventMethod == "attachEvent")? "onmessage": "message";
			window[eventMethod](messageEvent, function (e) {
				try{
					try{
						var data = JSON.parse(e.data);
					}
					catch(e){
						var data = {};
					}

					if(data.setConfig)
						elementsSetConfig(data);
					else
						iframeSetSize(data);

					// Envia uma mensagem informando que o iframe já foi renderizado
					frameHeader[0].contentWindow.postMessage("qdBiIframeRendered", "*");
					frameFooter[0].contentWindow.postMessage("qdBiIframeRendered", "*");
				}
				catch (e) {(typeof console !== "undefined" && typeof console.error === "function" && console.error("Ooops, algo deu errado com a comunicação entre iframe >> tela. . Detalhes: ", e)); }
			}, false);

			function iframeSetSize(data){
				if(data.bodyClass == "qd-blog-page-footer") 
					frameFooter.height(data.height || options.footer.height);
				if(data.bodyClass == "qd-blog-page") 
					frameHeader.height(data.height || options.header.height);
			}

			function elementsSetConfig(data) {
				if(data.bodyClass == "qd-blog-page-footer") {
					options.footer.height = data.height;
					frameFooter.height(options.footer.height);
					frameFooter.parent().height(options.footer.height);
				}

				if(data.bodyClass == "qd-blog-page") {
					options.header.position = data.position;
					frameHeader.css('position', options.header.position);

					options.header.height = data.height;
					frameHeader.height(options.header.height);
					frameHeader.parent().height(options.header.height);
				}
			}
		}
		catch (e) {(typeof console !== "undefined" && typeof console.error === "function" && console.error("Ooops, algo deu errado com a comunicação entre iframe >> tela. . Detalhes: ", e)); }
	};
})(jQuery, window);


jQuery(function($){
	$.QD_blogIntegration();
});